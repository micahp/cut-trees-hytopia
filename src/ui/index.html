<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="assets-base" content="{{CDN_ASSETS_URL}}" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: white;
      pointer-events: none;
    }

    /* ========== HUD ========== */
    .hud {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .hud-stat {
      background: rgba(0, 0, 0, 0.6);
      padding: 8px 14px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      backdrop-filter: blur(4px);
    }

    .hud-stat .label {
      color: rgba(255, 255, 255, 0.7);
    }

    .hud-stat .value {
      font-weight: bold;
      color: #ffd700;
    }

    .hud-stat.power .value { color: #7cfc00; }
    .hud-stat.shards .value { color: #00bfff; }
    .hud-stat.axe .value { color: #ff6b6b; }

    .hud-stat .icon-img {
      width: 24px;
      height: 24px;
      object-fit: contain;
      flex-shrink: 0;
    }

    /* ========== Chests Button ========== */
    .inventory-button {
      position: fixed;
      bottom: 100px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(255, 215, 0, 0.5);
      border-radius: 12px;
      padding: 12px 18px;
      cursor: pointer;
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .inventory-button:hover {
      background: rgba(0, 0, 0, 0.85);
      border-color: rgba(255, 215, 0, 0.8);
      transform: scale(1.05);
    }

    .inventory-button .icon-img,
.auto-chop-button .icon-img,
.backpack-button .icon-img {
  width: 24px;
  height: 24px;
  object-fit: contain;
}

.inventory-button .count {
      background: #ffd700;
      color: #000;
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }

    /* ========== Auto-Chop Button ========== */
    .auto-chop-button {
      position: fixed;
      bottom: 160px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(124, 252, 0, 0.5);
      border-radius: 12px;
      padding: 12px 18px;
      cursor: pointer;
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      user-select: none;
    }

    .auto-chop-button:hover {
      background: rgba(0, 0, 0, 0.85);
      border-color: rgba(124, 252, 0, 0.8);
      transform: scale(1.05);
    }

    .auto-chop-button.active {
      background: rgba(124, 252, 0, 0.3);
      border-color: rgba(124, 252, 0, 1);
      box-shadow: 0 0 12px rgba(124, 252, 0, 0.4);
    }

    .auto-chop-button .status {
      font-size: 10px;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .auto-chop-button.active .status {
      color: #7cfc00;
    }

    /* ========== Chest Panel ========== */
    .chest-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, rgba(40, 30, 20, 0.95), rgba(30, 20, 15, 0.95));
      border: 3px solid #8b4513;
      border-radius: 16px;
      padding: 24px;
      min-width: 400px;
      max-width: 90vw;
      max-height: 80vh;
      display: none;
      flex-direction: column;
      gap: 16px;
      pointer-events: auto;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .chest-panel.visible {
      display: flex;
    }

    .chest-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid rgba(139, 69, 19, 0.5);
      padding-bottom: 12px;
    }

    .chest-panel-header h2,
    .inventory-panel-header h2 {
      font-size: 20px;
      color: #ffd700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .title-icon {
      width: 28px;
      height: 28px;
      object-fit: contain;
    }

    .close-button {
      background: rgba(255, 100, 100, 0.3);
      border: none;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s;
    }

    .close-button:hover {
      background: rgba(255, 100, 100, 0.6);
    }

    .chest-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
      padding: 4px;
    }

    .chest-slot {
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(139, 69, 19, 0.6);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chest-slot:hover {
      border-color: #ffd700;
      transform: scale(1.05);
    }

    .chest-slot.common { border-color: #9d9d9d; }
    .chest-slot.rare { border-color: #4fc3f7; }
    .chest-slot.epic { border-color: #ba68c8; }
    .chest-slot.mythic { border-color: #ffd54f; }

    .chest-slot .icon {
      font-size: 28px;
    }

    .chest-slot .tier {
      font-size: 10px;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .empty-message {
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
      padding: 40px;
      font-style: italic;
    }

    /* ========== Loot Modal ========== */
    .loot-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      pointer-events: auto;
      z-index: 1000;
    }

    .loot-modal.visible {
      display: flex;
    }

    .loot-content {
      background: linear-gradient(145deg, rgba(50, 40, 30, 0.98), rgba(35, 25, 20, 0.98));
      border: 3px solid #ffd700;
      border-radius: 20px;
      padding: 32px;
      text-align: center;
      max-width: 400px;
      animation: lootPop 0.3s ease-out;
    }

    @keyframes lootPop {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .loot-title {
      font-size: 24px;
      color: #ffd700;
      margin-bottom: 20px;
    }

    .loot-items {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .loot-item {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .loot-item.axe {
      border: 2px solid #7cfc00;
    }

    .loot-item.shards {
      border: 2px solid #00bfff;
    }

    .loot-item .icon {
      font-size: 32px;
    }
    .loot-item .icon img.icon-img {
      width: 36px;
      height: 36px;
      object-fit: contain;
    }

    .loot-item .details {
      text-align: left;
    }

    .loot-item .name {
      font-weight: bold;
      font-size: 16px;
    }

    .loot-item .desc {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    .loot-item.common .name { color: #9d9d9d; }
    .loot-item.rare .name { color: #4fc3f7; }
    .loot-item.epic .name { color: #ba68c8; }
    .loot-item.mythic .name { color: #ffd54f; }
    .loot-item.exotic .name { color: #ff5252; }

    .loot-close {
      background: linear-gradient(145deg, #ffd700, #ffaa00);
      border: none;
      color: #000;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .loot-close:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(255, 215, 0, 0.4);
    }

    /* ========== Mobile Controls ========== */
    .mobile-controls {
      display: none;
    }

    body.mobile .mobile-controls {
      display: flex;
      gap: 14px;
      position: fixed;
      bottom: 40px;
      right: 40px;
    }

    .mobile-button {
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      display: flex;
      width: 50px;
      height: 50px;
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      pointer-events: auto !important;
    }
    
    .mobile-button img {
      width: 22px;
      height: 22px;
    }

    .mobile-button.active {
      transform: scale(0.92);
      background-color: rgba(0, 0, 0, 0.75);
    }

    /* ========== Rarity Colors ========== */
    .rarity-common { color: #9d9d9d; }
    .rarity-rare { color: #4fc3f7; }
    .rarity-epic { color: #ba68c8; }
    .rarity-mythic { color: #ffd54f; }
    .rarity-exotic { color: #ff5252; }

    /* ========== Inventory Panel ========== */
    .inventory-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(145deg, rgba(25, 30, 45, 0.96), rgba(15, 18, 30, 0.96));
      border: 3px solid rgba(100, 140, 255, 0.4);
      border-radius: 16px;
      padding: 24px;
      min-width: 520px;
      max-width: 90vw;
      max-height: 85vh;
      display: none;
      flex-direction: column;
      gap: 16px;
      pointer-events: auto;
      backdrop-filter: blur(8px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 60px rgba(80, 120, 255, 0.08);
      z-index: 500;
    }

    .inventory-panel.visible {
      display: flex;
    }

    .inventory-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 2px solid rgba(100, 140, 255, 0.25);
      padding-bottom: 12px;
    }

    .inventory-panel-header h2 {
      font-size: 20px;
      color: #a0c4ff;
    }

    .axe-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      overflow-y: auto;
      padding: 4px;
    }

    .axe-card {
      background: rgba(0, 0, 0, 0.35);
      border: 2px solid rgba(80, 80, 80, 0.4);
      border-radius: 12px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.2s;
      position: relative;
    }

    .axe-card.owned {
      cursor: pointer;
    }

    .axe-card.owned:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .axe-card.locked {
      opacity: 0.45;
    }

    .axe-card.equipped {
      box-shadow: 0 0 16px rgba(124, 252, 0, 0.2);
    }

    /* Rarity border colors for axe cards */
    .axe-card.rarity-common { border-color: rgba(157, 157, 157, 0.6); }
    .axe-card.rarity-rare { border-color: rgba(79, 195, 247, 0.6); }
    .axe-card.rarity-epic { border-color: rgba(186, 104, 200, 0.6); }
    .axe-card.rarity-mythic { border-color: rgba(255, 213, 79, 0.6); }
    .axe-card.rarity-exotic { border-color: rgba(255, 82, 82, 0.6); }

    .axe-card.equipped.rarity-common { border-color: #9d9d9d; }
    .axe-card.equipped.rarity-rare { border-color: #4fc3f7; }
    .axe-card.equipped.rarity-epic { border-color: #ba68c8; }
    .axe-card.equipped.rarity-mythic { border-color: #ffd54f; }
    .axe-card.equipped.rarity-exotic { border-color: #ff5252; }

    .axe-card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .axe-card-name {
      font-weight: bold;
      font-size: 15px;
    }

    .axe-card-rarity {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.3);
    }

    .axe-card-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
    }

    .axe-card-stats span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .axe-card-stats .stat-val {
      color: #fff;
      font-weight: 600;
    }

    .axe-card-badge {
      font-size: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 3px 10px;
      border-radius: 4px;
      text-align: center;
    }

    .axe-card-badge.equipped-badge {
      background: rgba(124, 252, 0, 0.2);
      color: #7cfc00;
      border: 1px solid rgba(124, 252, 0, 0.4);
    }

    .axe-card-badge.locked-badge {
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .axe-card-perk {
      font-size: 11px;
      color: #ffd54f;
      font-style: italic;
    }

    /* Backpack button */
    .backpack-button {
      position: fixed;
      bottom: 40px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      border: 2px solid rgba(100, 140, 255, 0.5);
      border-radius: 12px;
      padding: 12px 18px;
      cursor: pointer;
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .backpack-button:hover {
      background: rgba(0, 0, 0, 0.85);
      border-color: rgba(100, 140, 255, 0.8);
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <!-- HUD -->
  <div class="hud">
    <div class="hud-stat power">
      <img class="icon-img" src="{{CDN_ASSETS_URL}}/icons/Main/Lighting/64px/Lighting 1st 64px.png" alt="" />
      <span class="label">Power:</span>
      <span class="value" id="hud-power">0</span>
    </div>
    <div class="hud-stat shards">
      <img class="icon-img" src="{{CDN_ASSETS_URL}}/icons/currency/Crystal/64w/Crystal Blue 64px.png" alt="" />
      <span class="label">Shards:</span>
      <span class="value" id="hud-shards">0</span>
    </div>
    <div class="hud-stat axe">
      <img class="icon-img" id="hud-axe-icon" src="{{CDN_ASSETS_URL}}/icons/Item/Axe/64px/Axe 1st 64px.png" alt="" />
      <span class="label">Axe:</span>
      <span class="value" id="hud-axe">Wooden</span>
    </div>
  </div>

  <!-- Backpack / Inventory Button -->
  <div class="backpack-button" id="backpack-btn">
    <img class="icon-img" src="{{CDN_ASSETS_URL}}/icons/Item/Backpack/64px/Backpack 1st 64px.png" alt="" />
    <span>Inventory</span>
  </div>

  <!-- Chests Button -->
  <div class="inventory-button" id="inventory-btn">
    <img class="icon-img" src="{{CDN_ASSETS_URL}}/icons/Item/Chest/64px/Chest 1st 64px.png" alt="" />
    <span>Chests</span>
    <span class="count" id="chest-count">0</span>
  </div>

  <!-- Auto-Chop Button -->
  <div class="auto-chop-button" id="auto-chop-btn">
    <img class="icon-img" src="{{CDN_ASSETS_URL}}/icons/Item/Axe/64px/Axe 1st 64px.png" alt="" />
    <span>Auto Chop</span>
    <span class="status" id="auto-chop-status">OFF</span>
  </div>

  <!-- Inventory Panel -->
  <div class="inventory-panel" id="inventory-panel">
    <div class="inventory-panel-header">
      <h2><img class="icon-img title-icon" src="{{CDN_ASSETS_URL}}/icons/Item/Backpack/64px/Backpack 1st 64px.png" alt="" /> Inventory</h2>
      <button class="close-button" id="close-inventory">×</button>
    </div>
    <div class="axe-grid" id="axe-grid"></div>
  </div>

  <!-- Chest Panel -->
  <div class="chest-panel" id="chest-panel">
    <div class="chest-panel-header">
      <h2><img class="icon-img title-icon" src="{{CDN_ASSETS_URL}}/icons/Item/Chest/64px/Chest 1st 64px.png" alt="" /> Collected Chests</h2>
      <button class="close-button" id="close-panel">×</button>
    </div>
    <div class="chest-grid" id="chest-grid">
      <div class="empty-message">No chests collected yet.<br>Chop trees near chests to unlock them!</div>
    </div>
  </div>

  <!-- Loot Modal -->
  <div class="loot-modal" id="loot-modal">
    <div class="loot-content">
      <h2 class="loot-title"><img class="icon-img title-icon" src="{{CDN_ASSETS_URL}}/icons/UI/Checkmark/64px/Checkmark 1st 64px.png" alt="" /> Chest Opened!</h2>
      <div class="loot-items" id="loot-items"></div>
      <button class="loot-close" id="loot-close">Awesome!</button>
    </div>
  </div>

  <!-- Mobile Controls -->
  <div class="mobile-controls">
    <a id="mobile-interact-button" class="mobile-button">
      <img src="{{CDN_ASSETS_URL}}/icons/target.png" />
    </a>
    <a id="mobile-jump-button" class="mobile-button">
      <img src="{{CDN_ASSETS_URL}}/icons/jump.png" />
    </a>
  </div>

  <script>
    // ========== Asset base for icon URLs ==========
    const ASSETS_BASE = document.querySelector('meta[name="assets-base"]')?.getAttribute('content') || '';

    function iconUrl(path) {
      if (!ASSETS_BASE || !path) return '';
      const base = ASSETS_BASE.replace(/\/$/, '');
      const p = path.startsWith('icons/') ? path : 'icons/' + path;
      return base + '/' + p;
    }

    // Axe icon paths: game axe id -> path under icons/
    const AXE_ICON_PATHS = {
      wooden: 'Item/Axe/64px/Axe 1st 64px.png',
      stone: 'Item/Axe/64px/Axe 1st 64px.png',
      iron: 'Item/Axe/64px/Axe 1st 64px.png',
      golden: 'Item/Axe/64px/Axe 1st 64px.png',
      diamond: 'Item/Axe/64px/Axe 1st 64px.png',
      ruby: 'axes/png/ruby.png',
      sapphire: 'axes/png/sapphire.png',
      emerald: 'axes/png/emerald.png'
    };

    // Chest tier icon paths
    const CHEST_ICON_PATHS = {
      common: 'Item/Box/64px/Box 1st 64px.png',
      rare: 'Item/Gift/64px/Red Gift 1st 64px.png',
      epic: 'Item/Chest/64px/Chest 1st 64px.png',
      mythic: 'Item/Crown/64px/Crown 1st 64px.png'
    };

    const SHARDS_ICON_PATH = 'currency/Crystal/64w/Crystal Blue 64px.png';
    const LOCK_ICON_PATH = 'Item/Lock/64px/Lock 1st 64px.png';
    const CHECKMARK_ICON_PATH = 'UI/Checkmark/64px/Checkmark 1st 64px.png';

    // ========== State ==========
    let gameState = {
      power: 0,
      shards: 0,
      equippedAxeId: 'wooden',
      equippedAxe: 'Wooden Axe',
      collectedChests: [],
      ownedAxes: { wooden: 1 },
      allAxes: []  // filled by server on first stateUpdate
    };

    // Auto-chop state
    let autoChopEnabled = false;
    let autoChopInterval = null;
    const AUTO_CHOP_RATE_MS = 250; // Chop every 250ms (4 times per second)

    // ========== DOM Elements ==========
    const hudPower = document.getElementById('hud-power');
    const hudShards = document.getElementById('hud-shards');
    const hudAxe = document.getElementById('hud-axe');
    const chestCount = document.getElementById('chest-count');
    const inventoryBtn = document.getElementById('inventory-btn');
    const chestPanel = document.getElementById('chest-panel');
    const closePanel = document.getElementById('close-panel');
    const chestGrid = document.getElementById('chest-grid');
    const lootModal = document.getElementById('loot-modal');
    const lootItems = document.getElementById('loot-items');
    const lootClose = document.getElementById('loot-close');
    const autoChopBtn = document.getElementById('auto-chop-btn');
    const autoChopStatus = document.getElementById('auto-chop-status');
    const backpackBtn = document.getElementById('backpack-btn');
    const inventoryPanel = document.getElementById('inventory-panel');
    const closeInventory = document.getElementById('close-inventory');
    const axeGrid = document.getElementById('axe-grid');

    // ========== HUD Update ==========
    const hudAxeIcon = document.getElementById('hud-axe-icon');
    function updateHUD() {
      hudPower.textContent = gameState.power.toLocaleString();
      hudShards.textContent = gameState.shards.toLocaleString();
      hudAxe.textContent = gameState.equippedAxe;
      chestCount.textContent = gameState.collectedChests.length;
      const axePath = AXE_ICON_PATHS[gameState.equippedAxeId];
      if (hudAxeIcon && axePath) {
        const src = iconUrl(axePath);
        if (src) hudAxeIcon.src = src;
      }
    }

    // ========== Inventory Grid ==========
    const RARITY_ORDER = ['common', 'rare', 'epic', 'mythic', 'exotic'];

    function renderAxeGrid() {
      if (!gameState.allAxes || gameState.allAxes.length === 0) {
        axeGrid.innerHTML = '<div class="empty-message">Loading axes...</div>';
        return;
      }

      // Sort axes by rarity order
      const sorted = [...gameState.allAxes].sort((a, b) => {
        return RARITY_ORDER.indexOf(a.rarity) - RARITY_ORDER.indexOf(b.rarity);
      });

      axeGrid.innerHTML = sorted.map(axe => {
        const owned = (gameState.ownedAxes[axe.id] ?? 0) > 0;
        const equipped = gameState.equippedAxeId === axe.id;
        const classes = [
          'axe-card',
          `rarity-${axe.rarity}`,
          owned ? 'owned' : 'locked',
          equipped ? 'equipped' : ''
        ].filter(Boolean).join(' ');

        const perkHtml = axe.perk
          ? `<div class="axe-card-perk">${axe.perk}</div>`
          : '';

        const lockSrc = iconUrl(LOCK_ICON_PATH);
        const lockedBadgeContent = lockSrc
          ? `<img class="icon-img" src="${lockSrc}" alt="" /> Locked`
          : 'Locked';
        const badgeHtml = equipped
          ? '<div class="axe-card-badge equipped-badge">Equipped</div>'
          : (!owned ? `<div class="axe-card-badge locked-badge">${lockedBadgeContent}</div>` : '<div class="axe-card-badge" style="opacity:0.5;font-size:10px;color:rgba(255,255,255,0.5);">Click to equip</div>');

        return `
          <div class="${classes}" data-axe-id="${axe.id}">
            <div class="axe-card-top">
              <span class="axe-card-name rarity-${axe.rarity}">${axe.name}</span>
              <span class="axe-card-rarity rarity-${axe.rarity}">${axe.rarity}</span>
            </div>
            <div class="axe-card-stats">
              <span>Dmg <span class="stat-val">${axe.damage}</span></span>
              <span>Spd <span class="stat-val">${axe.cooldown}s</span></span>
              <span>Area <span class="stat-val">${axe.areaRadius}m</span></span>
            </div>
            ${perkHtml}
            ${badgeHtml}
          </div>
        `;
      }).join('');

      // Add click handlers for owned axes (equip)
      axeGrid.querySelectorAll('.axe-card.owned:not(.equipped)').forEach(card => {
        card.addEventListener('click', () => {
          const axeId = card.dataset.axeId;
          hytopia.sendData({ type: 'equipAxe', axeId: axeId });
        });
      });
      // Add click handlers for locked axes (show what's needed to equip)
      axeGrid.querySelectorAll('.axe-card.locked').forEach(card => {
        card.addEventListener('click', () => {
          const axeId = card.dataset.axeId;
          hytopia.sendData({ type: 'lockedAxeClick', axeId: axeId });
        });
      });
    }

    // ========== Chest Grid ==========
    function renderChestGrid() {
      if (gameState.collectedChests.length === 0) {
        chestGrid.innerHTML = '<div class="empty-message">No chests collected yet.<br>Chop trees near chests to unlock them!</div>';
        return;
      }

      chestGrid.innerHTML = gameState.collectedChests.map((chest, index) => {
        const path = CHEST_ICON_PATHS[chest.tier] || CHEST_ICON_PATHS.common;
        const src = iconUrl(path);
        const iconHtml = src
          ? `<span class="icon"><img class="icon-img" src="${src}" alt="" /></span>`
          : `<span class="icon">${chest.tier}</span>`;
        return `
        <div class="chest-slot ${chest.tier}" data-index="${index}">
          ${iconHtml}
          <span class="tier">${chest.tier}</span>
        </div>
      `;
      }).join('');

      // Add click handlers
      chestGrid.querySelectorAll('.chest-slot').forEach(slot => {
        slot.addEventListener('click', () => {
          const index = parseInt(slot.dataset.index, 10);
          if (!Number.isInteger(index) || index < 0 || index >= gameState.collectedChests.length) return;
          openChest(index);
        });
      });
    }

    // ========== Chest Opening ==========
    function openChest(index) {
      const chest = gameState.collectedChests[index];
      if (!chest || index < 0 || index >= gameState.collectedChests.length) return;

      hytopia.sendData({
        type: 'openChest',
        index: index,
        tier: chest.tier
      });

      // Close the panel while waiting for results
      chestPanel.classList.remove('visible');
    }

    function showLootResults(results) {
      if (!Array.isArray(results)) return;
      const shardsSrc = iconUrl(SHARDS_ICON_PATH);
      lootItems.innerHTML = results.map(item => {
        if (item.kind === 'axe') {
          const axePath = AXE_ICON_PATHS[item.axeId] || AXE_ICON_PATHS.wooden;
          const axeSrc = iconUrl(axePath) || iconUrl(AXE_ICON_PATHS.wooden);
          const iconHtml = `<span class="icon"><img class="icon-img" src="${axeSrc}" alt="" /></span>`;
          return `
            <div class="loot-item axe ${item.rarity}">
              ${iconHtml}
              <div class="details">
                <div class="name">${item.axeName}</div>
                <div class="desc">NEW ${item.rarity.toUpperCase()} AXE!</div>
              </div>
            </div>
          `;
        } else {
          const shardsImgSrc = shardsSrc || iconUrl(SHARDS_ICON_PATH);
          const iconHtml = `<span class="icon"><img class="icon-img" src="${shardsImgSrc}" alt="" /></span>`;
          return `
            <div class="loot-item shards">
              ${iconHtml}
              <div class="details">
                <div class="name">+${item.amount} Shards</div>
                <div class="desc">Duplicate ${item.axeName}</div>
              </div>
            </div>
          `;
        }
      }).join('');

      lootModal.classList.add('visible');
    }

    // ========== Panel Toggle ==========
    backpackBtn.addEventListener('click', () => {
      // Close other panels
      chestPanel.classList.remove('visible');
      renderAxeGrid();
      inventoryPanel.classList.toggle('visible');
    });

    closeInventory.addEventListener('click', () => {
      inventoryPanel.classList.remove('visible');
    });

    inventoryBtn.addEventListener('click', () => {
      // Close other panels
      inventoryPanel.classList.remove('visible');
      renderChestGrid();
      chestPanel.classList.toggle('visible');
    });

    closePanel.addEventListener('click', () => {
      chestPanel.classList.remove('visible');
    });

    lootClose.addEventListener('click', () => {
      lootModal.classList.remove('visible');
    });

    // Close panels on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        chestPanel.classList.remove('visible');
        inventoryPanel.classList.remove('visible');
        lootModal.classList.remove('visible');
      }
    });

    // ========== Auto-Chop Toggle ==========
    function toggleAutoChop() {
      autoChopEnabled = !autoChopEnabled;
      
      if (autoChopEnabled) {
        autoChopBtn.classList.add('active');
        autoChopStatus.textContent = 'ON';
        
        // Start auto-chopping - send chop requests to server
        autoChopInterval = setInterval(() => {
          hytopia.sendData({ type: 'requestChop' });
        }, AUTO_CHOP_RATE_MS);
      } else {
        autoChopBtn.classList.remove('active');
        autoChopStatus.textContent = 'OFF';
        
        // Stop auto-chopping
        if (autoChopInterval) {
          clearInterval(autoChopInterval);
          autoChopInterval = null;
        }
      }
    }

    autoChopBtn.addEventListener('click', toggleAutoChop);

    // Keyboard shortcut: 'R' to toggle auto-chop
    document.addEventListener('keydown', (e) => {
      if (e.key === 'r' || e.key === 'R') {
        // Don't toggle if typing in an input
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
          toggleAutoChop();
        }
      }
    });

    // ========== Server Communication ==========
    hytopia.onData(function(raw) {
      const data = raw && typeof raw === 'object' && raw.data !== undefined ? raw.data : raw;
      if (!data || typeof data !== 'object') return;
      try {
        console.log('UI received:', data);
        if (data.type === 'stateUpdate') {
          gameState.power = data.power ?? gameState.power;
          gameState.shards = data.shards ?? gameState.shards;
          gameState.equippedAxe = data.equippedAxe ?? gameState.equippedAxe;
          gameState.equippedAxeId = data.equippedAxeId ?? gameState.equippedAxeId;
          gameState.collectedChests = Array.isArray(data.collectedChests) ? data.collectedChests : gameState.collectedChests;
          gameState.ownedAxes = data.ownedAxes && typeof data.ownedAxes === 'object' ? data.ownedAxes : gameState.ownedAxes;
          if (data.allAxes && Array.isArray(data.allAxes)) gameState.allAxes = data.allAxes;
          updateHUD();
          if (chestPanel.classList.contains('visible')) renderChestGrid();
          if (inventoryPanel.classList.contains('visible')) renderAxeGrid();
        } else if (data.type === 'lootResults') {
          showLootResults(Array.isArray(data.results) ? data.results : []);
        } else if (data.type === 'chestCollected' && Array.isArray(data.collectedChests)) {
          gameState.collectedChests = data.collectedChests;
          updateHUD();
        }
      } catch (err) {
        console.error('[CutTrees UI] onData error:', err);
      }
    });

    // ========== Mobile Controls ==========
    const mobileInteractButton = document.getElementById('mobile-interact-button');
    mobileInteractButton.addEventListener('touchstart', e => {
      e.preventDefault();
      mobileInteractButton.classList.add('active');
      hytopia.pressInput('ml', true);
    });
    mobileInteractButton.addEventListener('touchend', e => {
      e.preventDefault();
      mobileInteractButton.classList.remove('active');
      hytopia.pressInput('ml', false);
    });

    const mobileJumpButton = document.getElementById('mobile-jump-button');
    mobileJumpButton.addEventListener('touchstart', e => {
      e.preventDefault();
      mobileJumpButton.classList.add('active');
      hytopia.pressInput(' ', true);
    });
    mobileJumpButton.addEventListener('touchend', e => {
      e.preventDefault();
      mobileJumpButton.classList.remove('active');
      hytopia.pressInput(' ', false);
    });

    // ========== Init ==========
    updateHUD();
  </script>
</body>
</html>
